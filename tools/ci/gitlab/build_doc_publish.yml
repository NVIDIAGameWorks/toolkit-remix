include:
  - project: 'omniverse/sectools/vault'
    file:
        - '/templates/v2/omni-packman-s3-creds.yml'
  # ^^^ includes above are needed for the vault invocation.

build_doc_publish:
  interruptible: true
  allow_failure: false
  variables:
    GIT_STRATEGY: fetch
  stage: build_doc_publish
  tags:
    - linux
  before_script:
    - ./build.sh --clean --release
  script:
    - set -eu
    - |
      mkdir tempbin
      curl -fsSL https://urm.nvidia.com/artifactory/sw-kaizen-data-generic/com/nvidia/vault/vault-agent/1.5.2/nvidia_vault_agent_v1.5.2_linux_amd64.zip \
      | bsdtar -xvf- -C tempbin
      chmod +x tempbin/vault
      export PATH="$PWD/tempbin:$PATH"
    - !reference [ .omni_s3_write_get_secrets, omni_s3_write_get_secrets ]
    - ./build.sh --release
    - ./build_docs.sh
    - ./build_docs.sh --publish-as-latest -s publish --edition s3web
  rules:
    ## Automatically run publish job only on merge commit to master
    - if: $CI_COMMIT_REF_NAME == "master" && $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_REF_NAME == "master" && $CI_PIPELINE_SOURCE == "push"
      when: always
    - when: never