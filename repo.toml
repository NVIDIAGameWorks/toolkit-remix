########################################################################################################################
# Repo tool base settings
########################################################################################################################

[repo]
logging = "warn"

# Use Kit Template repo configuration as a base. Only override things specific to the repo.
import_configs = ["${root}/_repo/deps/repo_kit_tools/kit-template/repo.toml"]

# Reposiory Name. It is used for solution name and final package name
name = "rtx_remix"

########################################################################################################################
# Test Runner
########################################################################################################################

# Run all test suites
[repo_test.suites.alltests]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.alltests.group]]
# Run all test
include = [
    "tests-lightspeed.*${shell_ext}"
]
"platform:linux-x86_64".include = ["tests-lightspeed.pip_archive${shell_ext}"]  # we only test pip archive for linux
exclude = []

"platform:linux-x86_64".exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--no-window"
]
timeout = 1800


# Run linux unit test suite
[repo_test.suites.unit_linux]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.unit_linux.group]]
include = [
    "tests-lightspeed.*${shell_ext}"
]
"platform:linux-x86_64".include = ["tests-lightspeed.pip_archive${shell_ext}"]  # we only test pip archive for linux
exclude = []
"platform:linux-x86_64".exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--no-window",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--/exts/omni.kit.test/runTestsFilter='lightspeed.*.tests.unit.*'",
    "--no-window"
]
timeout = 300


# Run unit test suite for windows, names starting with a-o
[repo_test.suites.unit_win_a2o]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.unit_win_a2o.group]]
include = [
    "tests-lightspeed.[a-o]*${shell_ext}"
]
exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--no-window",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--/exts/omni.kit.test/runTestsFilter='lightspeed.*.tests.unit.*'",
    "--no-window"
]
timeout = 900


# Run unit test suite for windows, names starting with p-z
[repo_test.suites.unit_win_p2z]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.unit_win_p2z.group]]
include = [
    "tests-lightspeed.[p-z]*${shell_ext}"
]
exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--no-window",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--/exts/omni.kit.test/runTestsFilter='lightspeed.*.tests.unit.*'",
    "--no-window"
]
timeout = 900


# Run end-to-end test suite, names starting with a-s
[repo_test.suites.e2e_a2s]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.e2e_a2s.group]]
include = [
    "tests-lightspeed.[a-s]*${shell_ext}"
]
"platform:linux-x86_64".include = ["tests-lightspeed.pip_archive${shell_ext}"]  # we only test pip archive for linux
exclude = []
"platform:linux-x86_64".exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--no-window",
    "--/exts/omni.kit.test/runTestsFilter='lightspeed.*.tests.e2e.*'",
]
timeout = 1800


# Run end-to-end test suite, names starting with t-z
[repo_test.suites.e2e_t2z]
kind = "glob_and_exec"
path = "${test_root}"

[[repo_test.suites.e2e_t2z.group]]
include = [
    "tests-lightspeed.[t-z]*${shell_ext}"
]
serial = [
    "tests-lightspeed.trex.viewports.shared.widget${shell_ext}",
]
"platform:linux-x86_64".include = ["tests-lightspeed.pip_archive${shell_ext}"]  # we only test pip archive for linux
exclude = []
"platform:linux-x86_64".exclude = []
args = [
    "--portable",
    "--portable-root",
    "./portable",
    "--/app/extensions/registryEnabled=0", # It should start ok without a registry enabled (everything prebundled)
    "--/app/hangDetector/enabled=0",
    "--/app/fastShutdown=1",
    "--/exts/omni.kit.test/testExtArgs/0=\"--/app/hangDetector/enabled=0\"",
    "--/exts/omni.kit.test/testExtArgs/1=\"--/app/fastShutdown=1\"",
    "--/exts/omni.kit.test/testExtArgs/2=\"--/rtx/verifyDriverVersion/enabled=false\"",
    "--/exts/omni.kit.test/testExtArgs/3=\"--no-window\"",
    "--no-window",
    "--/exts/omni.kit.test/runTestsFilter='lightspeed.*.tests.e2e.*'",
]
timeout = 1800

########################################################################################################################
# Packaging
########################################################################################################################

[repo_package]

[repo_package.packages.main_package]

archive_format = "zip"
replace_authors_in_kit_extensions = true
strip_package_infos = true
exclude_kit_extensions_for_thin_packaging = false

windows_max_path_length = 240

# temp for fat packaging and enterprise builds until pipeline changes are complete: @gamato
files_exclude = [
    ["**/*.pdb"],
    ["**/*.exp"],
    # ["kit/**"],
    ["baseapp/**"],
    ["extsbuild/**"],
    ["cache/**"],
    ["data/**"],
    ["logs/**"],
    ["apps/kit.portable"],
]

# package content
release.files = [
    ["**"],
]
release.files_exclude = [
    ["**/*.pdb"],
    ["**/*.exp"],
    # ["kit/**"],
    ["apps/kit.portable"],
]
"linux-x86_64".files_strip = [
    ["**/*.so"],
]
# temp until fix
"linux-x86_64".files_strip_exclude = [
    ["**/*tbb*.so"],
    ["*/pip_prebundle/PIL/*"],
]


#######################################################################################################################
# Section for "pre build", "post build" step configuration.
#######################################################################################################################
[repo_build]

pre_build.commands = [
    ["${root}/_build/${platform}/${config}/pull_dependencies${shell_ext}"],
]

# Multiple commands (processes) can be executed in order after build.
# These have the same behavior as repo_build.pre_build.commands, except that they run after the build.
post_build.commands = [
    ["${root}/repo${shell_ext}", "stubgen", "-c", "${config}"],
    # Generate a shortcut to run the Mass Ingestion CLI in LSS
    ["${root}/_build/${platform}/${config}/kit/kit${exe_ext}", "${root}/_build/${platform}/${config}/apps/lightspeed.app.trex.validation_cli_generator.kit", "--no-window", "--/app/extensions/excluded/0='omni.kit.splash' --/app/extensions/excluded/1='omni.kit.window.splash' --/app/settings/persistent=0 --/app/settings/loadUserConfig=0 --/structuredLog/enable=0 --/app/hangDetector/enabled=0 --/crashreporter/skipOldDumpUpload=1 --/app/content/emptyStageOnStart=1", "--/app/file/ignoreUnsavedOnExit=1", "--/app/fastShutdown=1", "--/app/quitAfter=10", "--exec", "${root}/tools/custom/generate_mass_cli.py"],
]

########################################################################################################################
# Extensions publisher
########################################################################################################################

[repo_publish_exts]
configs = ["release"]
platforms = ["windows-x86_64"]

# Extensions to publish, include and exclude among those discovered by kit. Wildcards are supported.
exts.include = [
    "lightspeed.*"
]
exts."platform:linux-x86_64".include = ["lightspeed.pip_archive.*"]  # we only test pip archive for linux
exts.exclude = [
    "lightspeed.app.*",
    "lightspeed_example.*",
]

# verify before publishing
publish_verification = true


########################################################################################################################
# Extensions precacher
########################################################################################################################

[repo_precache_exts]
# Apps to run and precache
apps = [
    "${root}/source/apps/lightspeed.app.trex.kit",
    "${root}/source/apps/lightspeed.app.trex.ingestcraft.kit",
    "${root}/source/apps/lightspeed.app.trex.validation_cli.kit",
    "${root}/source/apps/lightspeed.app.trex.validation_cli_generator.kit",
    "${root}/source/apps/lightspeed.app.trex.stagecraft.kit",
    "${root}/source/apps/lightspeed.app.trex.texturecraft.kit",
    "${root}/source/apps/lightspeed.app.trex_dev.kit",
    # we don't need to cache sub-apps, the extension itself is cached by an app. We can have a case where the sub app
    # use an extension that is not a dependency of the extension itself, but here this is not the case.
    # If you add a sub app here, please check this.
#    "${root}/source/extensions/lightspeed.trex.project_wizard.core/apps/lightspeed.app.trex.project_wizard_cli.kit",
#    "${root}/source/extensions/lightspeed.trex.packaging.core/apps/lightspeed.app.trex.project_packaging_cli.kit"
]



########################################################################################################################
# Documentation building
########################################################################################################################

[repo_docs]
enabled = true

name = "NVIDIA RTX Remix"
project = "${conf:repo.name}"

sphinx_exclude_patterns = [
    "include",
    "tools",
    "_build",
    "VERSION.md",
    "TESTING_GUIDELINES.md",
    "OMNIVERSE_TIPS.md",
    "PROFILE_GUIDE.md",
    "PYCHARM_GUIDE.md",
    "REVIEW_CHECKLIST.md",
    ".cache",
    ".local",
    "source/extensions/lightspeed.asset*",
    "source/extensions/lightspeed.color*",
    "source/extensions/lightspeed.common*",
    "source/extensions/lightspeed.error*",
    "source/extensions/lightspeed.event*",
    "source/extensions/lightspeed_example*",
    "source/extensions/lightspeed.export*",
    "source/extensions/lightspeed.layer*",
    "source/extensions/lightspeed.light.gizmos*",
    "source/extensions/lightspeed.lock*",
    "source/extensions/lightspeed.paths*",
    "source/extensions/lightspeed.pip*",
    "source/extensions/lightspeed.property*",
    "source/extensions/lightspeed.stage*",
    "source/extensions/lightspeed.tool*",
    "source/extensions/lightspeed.trex.layout.*",
    "source/extensions/lightspeed.trex.stage_view.shared.widget", # Kit is Executing extension-logic at the module-level which crashes docs generation
    "source/extensions/lightspeed.trex.viewports.*",
    "source/extensions/lightspeed.upscale*",
    "source/extensions/lightspeed.widget*",
    "source/extensions/lightspeed.window*",
    "source/extensions/lightspeed.workspace*",
]

python_paths = [
    "${root}/_build/${platform_target}/release/exts/*",
    "${root}/_build/${platform_target}/release/extscache/*",
    "${root}/_build/${platform_target}/release/kit/kernel/py",
    "${root}/_build/${platform_target}/release/kit/exts/*",
    "${root}/_build/${platform_target}/release/kit/extsPhysics/*",
    "${root}/_build/${platform_target}/release/kit/extscore/*",
    "${root}/_build/${platform_target}/release/kit/exts/omni.kit.pip_archive/pip_prebundle",
    "${root}/_build/${platform_target}/release/kit",
    "${root}/_build/${platform_target}/release/kit/kernel/py",
    "${root}/_build/${platform_target}/release/kit/plugins",
    "${root}/_build/${platform_target}/release/kit/plugins/bindings-python",
]
library_paths = [
    "${root}/_build/${platform_target}/release/exts/*/bin",
    "${root}/_build/${platform_target}/release/kit/exts/*/bin",
    "${root}/_build/${platform_target}/release/kit/exts/*/bin/deps",
    "${root}/_build/${platform_target}/release/kit/extsPhysics/*/bin",
    "${root}/_build/${platform_target}/release/kit/extscore/*/bin",
    "${root}/_build/${platform_target}/release/kit/extscore/*/bin/deps",
    "${root}/_build/${platform_target}/release/kit",
    "${root}/_build/${platform_target}/release/kit/kernel/plugins",
    "${root}/_build/${platform_target}/release/kit/plugins",
    "${root}/_build/${platform_target}/release/kit/plugins/carb_gfx",
    "${root}/_build/${platform_target}/release/kit/plugins/usd",
    "${root}/_build/${platform_target}/release/kit/plugins/rtx",
]

repo_url = "https://gitlab-master.nvidia.com/lightspeedrtx/lightspeed-kit/-/blob/master"

enable_dark_theme_switcher = true

########################################################################################################################
# Code Format Tool
########################################################################################################################

# C++ is formatted with clang-format:
[repo_format.cpp]
files.include = ["**"]
files.exclude = [
    ".vscode/*",
    "backup.teamcity/*",
    "_build/*",
    "_compiler/*",
    "_repo/*",
    ".git/*",
    ".eggs/*",
    ".venv/*",
    "venv/*",
    "tools/*",
    "source/pythonapps/*",
    "source/extensions/example.*",
    "source/extensions/lightspeed.common/lightspeed/common/tools/*",
    "source/extensions/lightspeed.hydra.remix/plugin/usd/usd/resources/codegenTemplates/*"
]

# python is formatted with black+isort:
[repo_format.python]
files.include = ["**/*.py"]
files.exclude = [
    ".vscode/*",
    "backup.teamcity/*",
    "_build/*",
    "_compiler/*",
    "_repo/*",
    ".git/*",
    ".eggs/*",
    ".venv/*",
    "venv/*",
    "tools/*",
    "source/pythonapps/*",
    "source/extensions/example.*",
    "source/extensions/lightspeed.common/lightspeed/common/tools/*",
]
python_version = "py310"
job_count = 1


########################################################################################################################
# Python lint tool
########################################################################################################################

[repo_lint]
files.include = ["**/*.py"]
files.exclude = [
    ".vscode/*",
    "backup.teamcity/*",
    "_build/*",
    "_compiler/*",
    "_repo/*",
    ".git/*",
    ".eggs/*",
    ".venv/*",
    "venv/*",
    "tools/*",
    "source/pythonapps/*",
    "source/extensions/example.*",
    "source/extensions/lightspeed.common/lightspeed/common/tools/*",
]

########################################################################################################################
# Launcher publish and deploy
########################################################################################################################

[repo_deploy_launcher]
enabled = true
git_url = "https://oauth2:${env:TREX_RELEASE_TOKEN}@gitlab-master.nvidia.com/omniverse/trex-release-pipeline.git"

########################################################################################################################
# Check test file locations
########################################################################################################################

[repo_check_test_file_location]
start_path = "source\\"
required_paths = ["/unit/", "/e2e/"]
# Any path containing any of the 'ignore' strings will be skipped
ignore = ["extensions/lightspeed.common/lightspeed/common/tools"]
